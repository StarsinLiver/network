## 리눅스 서버의 방화벽 확인 및 관리

리눅스에서는 호스트 방화벽 기능을 위해 보통 iptables 을 많이 사용합니다. CentOS7 이상은 기본적으로 iptables 이 아닌 firewalld 를 사용하도록 되어 있으며 Ubuntu 에서는 UFW(Ubuntu Firewall)를 사용해 방화벽 서비스를 제공합니다.

하지만 iptables에 익숙한 사용자들이 많아 firewalld 대신 iptables 을 이용하는 경우가 여전히 많고 UFW는 iptables의 프론트엔드 역할을 수행하므로 iptables 에 대한 기본적인 이해가 필요합니다.

```
참조 : iptables , firewalld 와 netfilter 의 관계

실제 iptables 는 방화벽의 역할처럼 패킷을 차단, 허용하는 등의 필터링 기능을 직접 수행하는 것은 아니며
리눅스 커널에 내장된 netfilter 라는 리눅스 커널 모듈을 통해 실제로 필터링이 이루어집니다.

iptables 는 netfilter 를 이용할 수 있도록 해주는 사용자 공간 응용 프로그램(User space Application) 입니다.

iptables 나 firewalld (CentOS) , UFW(Ubuntu) 모두 결국 netfilter에 대한 프론드엔드 역할이라고 생각하면 쉽습니다.
```

### 1. iptables 이해하기

시스템 관리자는 iptables 을 통해 서버에서 허용하거나 차단할 IP 나 서비스 포트에 대한 정책 (Rule) 을 수립합니다. 이렇게 수립된 정책은 정책 그룹으로 관리합니다. 정책 그룹은 서버 기준의 트래픽 구간별로 만드는데 여기서 말하는 트래픽 구간은 서버로 유입되는 구간 (INPUT) , 서버에서 나가는 구간(OUTPUT), 서버를 통과하는 구간 (FORWARD) 등을 말합니다.

그리고 이렇게 만들어진 방향성과 관련된 정책 그룹은 각 정책의 역할에 따라 다시 상위 역할 그룹에 속하게 됩니다.

정리하면 적책은 방향성에 따라 방향성과 관련된 정책 그룹을 분류하고 이렇게 분류된 그룹들은 역할과 관련된 정책 그룹으로 다시 묶이게 됩니다.

iptables 에서 개별 정책의 방향성에 따라 구분한 그룹ㅇ르 체인(Chain) 이라고 하며 체인을 역할별로 구분한 그룹을 테이블(Table) 이라고 합니다. 즉, 개별 정책의 그룹이 체인되고 체인 그룹이 테이블입니다.

![alt text](./image/image213.png)

iptables 에는 필터 (Filter) 테이블 , NAT 테이블 , 맹글(Mangle) 테이블 , 로(Raw) 테이블 , 시큐리티 (Security) 테이블 이렇게 5가지 테이블이 있습니다.

![alt text](./image/image214.png)

패킷을 허용하거나 차단하는 데 사용하는 테이블이 필터 테이블입니다. 여기서 다룰 리눅스의 호스트 방화벽은 이 필터 테이블을 통해 트래픽을 제어하는 것을 의미합니다.

테이블에는 방향성과 관련된 그룹이 있다고 했는데 이 그룹이 체인(Chain)입니다. 필터 테이블에는 서버로 들어오는 트래픽 , 나가는 트래픽 , 통과하는 트래픽에 따라 INPUT 체인 , OUTPUT 체인, FORWARD 체인이 있습니다. 각 체인에는 해당 체인에 적용될 방화벽 정책을 정의합니다. 각 정책에는 정책을 적용하려는 패킷과 상태 또는 정보 값과의 일치 여부 조건인 매치 (Match)와 조건이 일치하는 패킷의 허용 (Accept) 이나 폐기 (Drop) 에 대한 패킷 처리 방식을 결정하는 타깃(Target) 으로 구성됩니다.

리눅스에서 방화벽의 역할을 위해 사용되는 것을 정리하면 다음과 같습니다.

#### Filter 테이블

iptables 에서 패킷을 허용하거나 차단하는 역할을 선언하는 영역

#### INPUT , OUTPUT , FORWARD 체인

호스트 기준으로 호스트로 들어오거나 (INPUT) , 호스트에서 나가거나 (OUTPUT) , 호스트를 통과할 (FORWARD) 때 사용되는 정책들의 그룹, 패킷의 방향성에 따라 각 체인에 정의된 정책이 적용됨

#### Match

제어하려는 패킷의 상태 또는 정보 값의 정의 , 정책에 대한 조건

#### Target

Match (조건)와 일치하는 패킷을 허용할 지, 차단할지에 대한 패킷 처리 방식

### 2. 리눅스 방화벽 활성화/비활성화

iptables 을 구성하고 설정하는 방법에 대해 알아보겠습니다. CentOS 7 을 기준으로 진행하면 모든 예제는 IPv4 기준입니다.

CentOS 7 을 이후 버전부턴느 iptables 이 기본적으로 포함되지 않고 firewalld 가 활성화되어 있어 firewalld 서비스를 비활성화하고 iptables 를 설치해야 iptables 를 사용할 수 있습니다.

```
firewalld 비활성화 및 서비스 중단

# systemctl disable firewalld
# systemctl stop firewalld

iptables 설치
# dnf install iptables-services
```

service 명령어나 systemctl 명령어로 iptables 서비스를 활성화 합니다.

```
iptables 서비스 활성화 및 시작하기

# systemctl start iptables.service
```

### 3. 리눅스 방화벽 정책 확인

iptables 정책을 어떤 식으로 설정되는 iptables 의 기본 설정 값을 통해 알아보겠습니다. iptables 의 설정값을 확인하는 명령은 -L (--list) 옵션을 사용합니다.

```
iptables 정책 확인

# iptables -L


```

앞에서 알아보았던 INPUT , FORWARD , OUTPUT 체인별로 구분된 정책을 확인할 수 있습니다. 체인별로 기본값이 적용된 정책을 살펴볼 수 있는데 여기서는 외부에서 서버로 접근할 때 사용되는 체인 INPUT에 대해서만 살펴보겠습니다.
